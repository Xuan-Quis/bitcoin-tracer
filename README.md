# üöÄ CoinJoin Detection & Investigation API

API ph√°t hi·ªán v√† ƒëi·ªÅu tra s√¢u c√°c giao d·ªãch CoinJoin t·ª´ mempool real-time v·ªõi kh·∫£ nƒÉng l∆∞u tr·ªØ v√†o Neo4j v√† truy v·∫øt s√¢u theo lu·ªìng giao d·ªãch.

## üéØ **K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c**

‚úÖ **Deep Tracing**: C√≥ th·ªÉ truy v·∫øt s√¢u ƒë·∫øn 6+ levels v·ªõi c√¢y giao d·ªãch ph·ª©c t·∫°p  
‚úÖ **Performance**: T·ªëi ∆∞u v·ªõi c∆° ch·∫ø d·ª´ng th√¥ng minh  
‚úÖ **CoinJoin Detection**: K·∫øt h·ª£p heuristic + ML model  
‚úÖ **Neo4j Storage**: L∆∞u tr·ªØ ƒë·ªì th·ªã giao d·ªãch ho√†n ch·ªânh  

## üöÄ **T√≠nh nƒÉng ch√≠nh**

### 1. **Mempool Monitoring**
- Gi√°m s√°t mempool Bitcoin real-time (m·ªói 1 gi√¢y)
- T·ª± ƒë·ªông ph√°t hi·ªán CoinJoin transactions
- K·∫øt h·ª£p heuristic + ML model ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c

### 2. **Deep Investigation (DFS)**
- ƒêi·ªÅu tra s√¢u c√°c giao d·ªãch CoinJoin v·ªõi thu·∫≠t to√°n DFS
- **Truy v·∫øt s√¢u**: T·ªëi ƒëa 10 levels v·ªõi c∆° ch·∫ø d·ª´ng th√¥ng minh
- **Branch control**: T·ªëi ƒëa 5 nh√°nh con m·ªói n√∫t
- **Performance optimization**: T·ª± ƒë·ªông d·ª´ng khi v∆∞·ª£t gi·ªõi h·∫°n

### 3. **Neo4j Storage**
- L∆∞u tr·ªØ ƒë·ªì th·ªã CoinJoin v√†o Neo4j database
- Schema: Transaction, Address, Investigation nodes
- Relationships: INPUT_TO, OUTPUT_TO, RELATED_TO

### 4. **Cache System**
- LRU Cache v·ªõi TTL ƒë·ªÉ t·ªëi ∆∞u memory
- Cache transaction v√† address data trong su·ªët request
- Gi·∫£m s·ªë l∆∞·ª£ng API calls ƒë·∫øn Blockstream

## üèóÔ∏è **Ki·∫øn tr√∫c**

```
api/
‚îú‚îÄ‚îÄ mempool_monitor.py      # Gi√°m s√°t mempool real-time
‚îú‚îÄ‚îÄ coinjoin_investigator.py # ƒêi·ªÅu tra s√¢u v·ªõi DFS (T·ªêI ∆ØU)
‚îú‚îÄ‚îÄ neo4j_storage.py        # L∆∞u tr·ªØ v√†o Neo4j
‚îú‚îÄ‚îÄ rest_api.py            # REST API endpoints
‚îú‚îÄ‚îÄ blockchain_api.py      # Interface v·ªõi blockchain APIs
‚îú‚îÄ‚îÄ detector_adapter.py    # Heuristic detection
‚îî‚îÄ‚îÄ ml_detector.py         # ML model integration

utils/
‚îú‚îÄ‚îÄ cache.py               # LRU Cache v·ªõi TTL
‚îú‚îÄ‚îÄ config.py              # Configuration management
‚îî‚îÄ‚îÄ logger.py              # Logging system
```

## üöÄ **C√†i ƒë·∫∑t**

### 1. **C√†i ƒë·∫∑t dependencies**
```bash
pip install -r requirements.txt
```

### 2. **C·∫•u h√¨nh Neo4j**
ƒê·∫£m b·∫£o Neo4j ƒëang ch·∫°y t·∫°i `192.168.100.128:7687` ho·∫∑c c·∫≠p nh·∫≠t config trong `config/api_config.yaml`.

### 3. **Kh·ªüi ƒë·ªông API**
```bash
python start_api.py
```

API s·∫Ω ch·∫°y t·∫°i: http://localhost:8000

## üìö **API Endpoints**

### **Investigation & Analysis**

#### `POST /investigate` - ƒêi·ªÅu tra s√¢u giao d·ªãch
**M·ª•c ƒë√≠ch**: Ph√¢n t√≠ch s√¢u m·ªôt giao d·ªãch v√† x√¢y d·ª±ng c√¢y truy v·∫øt

**Request Body**:
```json
{
    "txid": "73976d7045c31a184971b570e69c2a88fd50554b78020caa763052bde5ee91cb",
    "max_depth": 10
}
```

**Response Example** (Deep Tracing Result - COMPLETE):
```json
{
    "mode": "tx",
    "txid": "73976d7045c31a184971b570e69c2a88fd50554b78020caa763052bde5ee91cb",
    "is_coinjoin": true,
    "heuristic": {
        "is_coinjoin": true,
        "detection_method": "wasabi",
        "score": 0.5,
        "reasons": [
            "Wasabi heuristic (0.1 BTC pattern)"
        ],
        "indicators": {
            "input_count": 63,
            "output_count": 87,
            "unique_input_addresses": 63,
            "unique_output_addresses": 87,
            "output_uniformity": 33,
            "input_diversity": 63,
            "transaction_size": 150
        },
        "uniformity_score": 0.5402298850574713,
        "diversity_score": 1.0,
        "wasabi_detected": true,
        "samourai_detected": false,
        "exchange_like_score": 0.3,
        "exchange_reasons": [
            "Many addresses involved"
        ]
    },
    "ml": {
        "is_coinjoin": true,
        "probability": 0.9345043370508055,
        "model_name": "ml_model",
        "threshold": 0.7
    },
    "tree": {
        "tx": {
            "txid": "73976d7045c31a184971b570e69c2a88fd50554b78020caa763052bde5ee91cb",
            "vin_count": 63,
            "vout_count": 87,
            "fee": 15747,
            "size": 12033
        },
        "out": [
            {
                "tx": {
                    "txid": "6bffae2818764ce043608011c8d76761e27d65d9e18487db90c81a5aa4e8b905",
                    "vin_count": 88,
                    "vout_count": 114,
                    "fee": 21556,
                    "size": 16570
                },
                "out": [
                    {
                        "tx": {
                            "txid": "a13ef8228624339707bf3768c97a805779c013e89bca0d2de09018fdfbf4400b",
                            "vin_count": 73,
                            "vout_count": 111,
                            "fee": 18922,
                            "size": 14256
                        },
                        "out": [
                            {
                                "tx": {
                                    "txid": "219b873c6d931edd29b2c2c043d8b57b9ce81fdbecd1c35f292b45ba3ec565ff",
                                    "vin_count": 77,
                                    "vout_count": 131,
                                    "fee": 20780,
                                    "size": 15468
                                },
                                "out": [
                                    {
                                        "tx": {
                                            "txid": "1c610ac494521de7c35b6f7a883e8fb4e1945a6a8e37c4afecae901cb1e2e8b0",
                                            "vin_count": 51,
                                            "vout_count": 1,
                                            "fee": 35100,
                                            "size": 7591
                                        },
                                        "out": [
                                            {
                                                "tx": {
                                                    "txid": "5a7ebc077c236c23ace2283e557f09816c016729d7bd584584327ffbb6f0a24f",
                                                    "vin_count": 6,
                                                    "vout_count": 1,
                                                    "fee": 4301,
                                                    "size": 931
                                                },
                                                "out": []
                                            }
                                        ]
                                    },
                                    {
                                        "tx": {
                                            "txid": "af209804389d031d4a50efcbac9e3fc732d2f4a476e6a21bd171756b53edabca",
                                            "vin_count": 3,
                                            "vout_count": 1,
                                            "fee": 4940,
                                            "size": 488
                                        },
                                        "out": [
                                            {
                                                "tx": {
                                                    "txid": "36a41004e82f81f42b10355079f3d53ce5caed5389ca1d0e8ea0bec5109c021e",
                                                    "vin_count": 53,
                                                    "vout_count": 1,
                                                    "fee": 92760,
                                                    "size": 9106
                                                },
                                                "out": []
                                            },
                                            {
                                                "tx": {
                                                    "txid": "753f26638cef8d675c5059186b7787e1cb9a18d6947c47283e92595f5abbd37f",
                                                    "vin_count": 125,
                                                    "vout_count": 1,
                                                    "fee": 57663,
                                                    "size": 21418
                                                },
                                                "out": []
                                            },
                                            {
                                                "tx": {
                                                    "txid": "c1c318930bebe136a8ac6852575b1b55a0d8abbee8aba1c18bd32139b3471c6b",
                                                    "vin_count": 117,
                                                    "vout_count": 1,
                                                    "fee": 21439,
                                                    "size": 20051
                                                },
                                                "out": []
                                            },
                                            {
                                                "tx": {
                                                    "txid": "d6eb4d042f8317efbc2fcac53d913bb42f0c358f6e8ec5f441f577e30dd82ccd",
                                                    "vin_count": 152,
                                                    "vout_count": 1,
                                                    "fee": 43365,
                                                    "size": 26033
                                                },
                                                "out": []
                                            },
                                            {
                                                "tx": {
                                                    "txid": "2dd48178ac204a4738a482e714a3448ccc5ca6c6d0de4883fa35f47bd2029fb5",
                                                    "vin_count": 58,
                                                    "vout_count": 1,
                                                    "fee": 21308,
                                                    "size": 9962
                                                },
                                                "out": []
                                            }
                                        ]
                                    },
                                    {
                                        "tx": {
                                            "txid": "467ca0d9208f65ec472a118d75678973a9cfc843fc83416be01bb679c42152db",
                                            "vin_count": 77,
                                            "vout_count": 98,
                                            "fee": 18724,
                                            "size": 14446
                                        },
                                        "out": []
                                    },
                                    {
                                        "tx": {
                                            "txid": "301e7ed3f649ffb2e9e3e826aff56cd85d9d34642b4b44f0785a302762e1b31a",
                                            "vin_count": 9,
                                            "vout_count": 1,
                                            "fee": 2664,
                                            "size": 1387
                                        },
                                        "out": []
                                    },
                                    {
                                        "tx": {
                                            "txid": "6b20962996a3142d29d87df69816b9a0e633bf929c1a06101ce842d0c689d013",
                                            "vin_count": 71,
                                            "vout_count": 120,
                                            "fee": 19104,
                                            "size": 14239
                                        },
                                        "out": []
                                    }
                                ]
                            },
                            {
                                "tx": {
                                    "txid": "b3fa63c680003b3316b42059d02b3aca9e768beeed7c04276af31c373e7b7a02",
                                    "vin_count": 6,
                                    "vout_count": 1,
                                    "fee": 2700,
                                    "size": 931
                                },
                                "out": []
                            },
                            {
                                "tx": {
                                    "txid": "7b19429447e75f45558fd7d5ddb9d7af30ffdd61ba45b7e49568ff8b4914cb6a",
                                    "vin_count": 75,
                                    "vout_count": 89,
                                    "fee": 17850,
                                    "size": 13871
                                },
                                "out": []
                            },
                            {
                                "tx": {
                                    "txid": "113bf3ccf512f47cf546ef0ef30b672ca8aaabbbccc6d44a2e2e66fdbaca4f08",
                                    "vin_count": 4,
                                    "vout_count": 1,
                                    "fee": 1256,
                                    "size": 635
                                },
                                "out": []
                            }
                        ]
                    },
                    {
                        "tx": {
                            "txid": "10e6725b50224551370d0d7713b9a7f9da495737dbf99ebcd9439cdf81c7305b",
                            "vin_count": 72,
                            "vout_count": 101,
                            "fee": 18121,
                            "size": 13799
                        },
                        "out": []
                    },
                    {
                        "tx": {
                            "txid": "de0f0537a2492aed592b2f7c922134c21fdae1fb927c31a43bc60018cd92bf5e",
                            "vin_count": 64,
                            "vout_count": 89,
                            "fee": 16060,
                            "size": 12241
                        },
                        "out": []
                    },
                    {
                        "tx": {
                            "txid": "9db4f2093de7f30ca78b3412f613a5ae20f4f83ca584a8f9c1416bca3ee82b7b",
                            "vin_count": 20,
                            "vout_count": 1,
                            "fee": 8412,
                            "size": 3003
                        },
                        "out": []
                    },
                    {
                        "tx": {
                            "txid": "10e6725b50224551370d0d7713b9a7f9da495737dbf99ebcd9439cdf81c7305b",
                            "vin_count": 72,
                            "vout_count": 101,
                            "fee": 18121,
                            "size": 13799
                        },
                        "out": []
                    }
                ]
            },
            {
                "tx": {
                    "txid": "66354d8a98a05bf265e67004216be6cd3e3bfd65c94116f314e9149202ec1bf5",
                    "vin_count": 1,
                    "vout_count": 2,
                    "fee": 568,
                    "size": 223
                },
                "out": []
            },
            {
                "tx": {
                    "txid": "81079a4da09c1f1444d6d1a8a92b393db307d0191bf6c2a2a41f5cb603c4efd6",
                    "vin_count": 5,
                    "vout_count": 1,
                    "fee": 1925,
                    "size": 786
                },
                "out": []
            },
            {
                "tx": {
                    "txid": "1be3f3fc3b16a6f7cb7fba184e66de01c089ee3d8a7e896a5663ee1c992c596d",
                    "vin_count": 5,
                    "vout_count": 1,
                    "fee": 2292,
                    "size": 783
                },
                "out": []
            }
        ]
    }
}
```

**Gi·∫£i th√≠ch c·∫•u tr√∫c c√¢y truy v·∫øt**:
- **Root Transaction**: Giao d·ªãch CoinJoin g·ªëc (63 inputs, 87 outputs)
- **Level 1**: 4 giao d·ªãch con ch√≠nh
- **Level 2**: Giao d·ªãch ƒë·∫ßu ti√™n c√≥ 8 giao d·ªãch con
- **Level 3**: Giao d·ªãch con c√≥ 9 giao d·ªãch con
- **Level 4**: Giao d·ªãch con c√≥ 7 giao d·ªãch con
- **Level 5**: Giao d·ªãch con c√≥ 6 giao d·ªãch con
- **Level 6**: Giao d·ªãch con c√≥ 1 giao d·ªãch con

**T·ªïng c·ªông**: 6+ levels v·ªõi c√¢y giao d·ªãch ph·ª©c t·∫°p, th·ªÉ hi·ªán kh·∫£ nƒÉng truy v·∫øt s√¢u c·ªßa h·ªá th·ªëng.

#### `POST /search/address` - T√¨m ki·∫øm theo ƒë·ªãa ch·ªâ
**M·ª•c ƒë√≠ch**: Ph√¢n t√≠ch t·∫•t c·∫£ giao d·ªãch c·ªßa m·ªôt ƒë·ªãa ch·ªâ

**Request Body**:
```json
{
    "address": "bc1q...",
    "max_depth": 8
}
```

### **Monitoring & Control**

- `POST /monitoring/start` - B·∫Øt ƒë·∫ßu gi√°m s√°t mempool
- `POST /monitoring/stop` - D·ª´ng gi√°m s√°t mempool  
- `GET /monitoring/status` - Tr·∫°ng th√°i monitoring

### **Cache Management**
- `GET /cache/status` - Xem tr·∫°ng th√°i cache
- `POST /cache/clear` - X√≥a to√†n b·ªô cache
- `POST /cache/cleanup` - D·ªçn d·∫πp cache h·∫øt h·∫°n

### **Statistics & Health**
- `GET /statistics` - Th·ªëng k√™ CoinJoin
- `GET /health` - Health check

## üîß **S·ª≠ d·ª•ng API**

### **1. ƒêi·ªÅu tra s√¢u m·ªôt giao d·ªãch**

```bash
curl -X POST "http://localhost:8000/investigate" \
  -H "Content-Type: application/json" \
  -d '{
    "txid": "73976d7045c31a184971b570e69c2a88fd50554b78020caa763052bde5ee91cb",
    "max_depth": 10
  }'
```

### **2. T√¨m ki·∫øm theo ƒë·ªãa ch·ªâ**

```bash
curl -X POST "http://localhost:8000/search/address" \
  -H "Content-Type: application/json" \
  -d '{
    "address": "bc1q...",
    "max_depth": 8
  }'
```

### **3. B·∫Øt ƒë·∫ßu monitoring**

```bash
curl -X POST "http://localhost:8000/monitoring/start"
```

### **4. Ki·ªÉm tra tr·∫°ng th√°i**

```bash
curl "http://localhost:8000/monitoring/status"
```

## üóÑÔ∏è **Neo4j Schema**

### **Nodes**

- **Transaction**: Giao d·ªãch CoinJoin
  - `txid`: ID giao d·ªãch
  - `coinjoin_score`: ƒêi·ªÉm CoinJoin
  - `detection_method`: Ph∆∞∆°ng ph√°p ph√°t hi·ªán
  - `fee`, `size`: Th√¥ng tin giao d·ªãch

- **Address**: ƒê·ªãa ch·ªâ Bitcoin
  - `address`: ƒê·ªãa ch·ªâ
  - `type`: 'coinjoin' ho·∫∑c 'related'
  - `first_seen`, `last_seen`: Th·ªùi gian xu·∫•t hi·ªán

- **Investigation**: Metadata ƒëi·ªÅu tra
  - `depth_reached`: ƒê·ªô s√¢u DFS
  - `addresses_processed`: S·ªë ƒë·ªãa ch·ªâ x·ª≠ l√Ω

### **Relationships**

- `(Address)-[:INPUT_TO]->(Transaction)`: ƒê·ªãa ch·ªâ input
- `(Transaction)-[:OUTPUT_TO]->(Address)`: ƒê·ªãa ch·ªâ output  
- `(Address)-[:RELATED_TO]->(Transaction)`: ƒê·ªãa ch·ªâ li√™n quan

## ‚öôÔ∏è **C·∫•u h√¨nh**

Ch·ªânh s·ª≠a `config/api_config.yaml`:

```yaml
# Investigation Configuration
investigation:
  max_depth: 10                    # ƒê·ªô s√¢u t·ªëi ƒëa
  max_transactions_per_address: 15 # S·ªë giao d·ªãch t·ªëi ƒëa m·ªói ƒë·ªãa ch·ªâ
  max_addresses_per_tx: 25         # S·ªë ƒë·ªãa ch·ªâ t·ªëi ƒëa m·ªói giao d·ªãch
  max_branches_per_node: 5         # S·ªë nh√°nh con t·ªëi ƒëa m·ªói n√∫t
  
  # Performance Optimization
  max_total_nodes: 1000            # Gi·ªõi h·∫°n t·ªïng s·ªë nodes
  max_time_seconds: 60             # Gi·ªõi h·∫°n th·ªùi gian (gi√¢y)
  min_coinjoin_ratio: 0.1          # T·ª∑ l·ªá CoinJoin t·ªëi thi·ªÉu

# Neo4j
neo4j:
  uri: "bolt://192.168.100.128:7687"
  user: "neo4j"
  password: "password123"
```

## üìä **Performance & Monitoring**

### **Logs**
Logs ƒë∆∞·ª£c l∆∞u t·∫°i `logs/api.log`

### **Metrics**
- S·ªë giao d·ªãch ƒë√£ x·ª≠ l√Ω
- S·ªë CoinJoin ph√°t hi·ªán
- Th·ªùi gian ph·∫£n h·ªìi
- Tr·∫°ng th√°i Neo4j connection

### **Performance Targets**
- **Latency**: < 60s cho deep tracing (depth 10)
- **Throughput**: 1000+ transactions/gi·ªù
- **Memory**: ~100MB cho deep investigation
- **Cache Hit Rate**: >80%

## üîç **V√≠ d·ª• s·ª≠ d·ª•ng Python**

### **1. Gi√°m s√°t real-time**

```python
import asyncio
import aiohttp

async def monitor_coinjoin():
    async with aiohttp.ClientSession() as session:
        # B·∫Øt ƒë·∫ßu monitoring
        async with session.post("http://localhost:8000/monitoring/start") as resp:
            print("Monitoring started")
        
        # Ki·ªÉm tra tr·∫°ng th√°i m·ªói 30 gi√¢y
        while True:
            async with session.get("http://localhost:8000/monitoring/status") as resp:
                status = await resp.json()
                print(f"Processed: {status['processed_transactions']}, CoinJoins: {status['detected_coinjoins']}")
            
            await asyncio.sleep(30)

asyncio.run(monitor_coinjoin())
```

### **2. ƒêi·ªÅu tra s√¢u giao d·ªãch**

```python
import asyncio
import aiohttp

async def investigate_transaction(txid: str, max_depth: int = 10):
    async with aiohttp.ClientSession() as session:
        payload = {
            "txid": txid,
            "max_depth": max_depth
        }
        
        async with session.post("http://localhost:8000/investigate", json=payload) as resp:
            result = await resp.json()
            
            # Analyze tree structure
            tree = result.get('tree', {})
            output_count = len(tree.get('out', []))
            print(f"Found {output_count} output transactions")
            
            return result

# Usage
result = asyncio.run(investigate_transaction(
    "73976d7045c31a184971b570e69c2a88fd50554b78020caa763052bde5ee91cb",
    max_depth=10
))
```

## üö® **Troubleshooting**

### **L·ªói k·∫øt n·ªëi Neo4j**
1. Ki·ªÉm tra Neo4j ƒëang ch·∫°y
2. Ki·ªÉm tra IP v√† port trong config
3. Ki·ªÉm tra password trong docker-compose

### **Performance issues**
1. Gi·∫£m `max_depth` v√† `max_transactions_per_address`
2. TƒÉng `max_time_seconds` n·∫øu c·∫ßn truy v·∫øt s√¢u h∆°n
3. Monitor memory usage v√† cache hit rate

### **API rate limit**
1. TƒÉng `rate_limit` trong config
2. Ki·ªÉm tra k·∫øt n·ªëi internet
3. Xem logs ƒë·ªÉ debug

## üìà **K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c**

### **Deep Tracing Capability**
- ‚úÖ **Depth 6+**: C√≥ th·ªÉ truy v·∫øt s√¢u ƒë·∫øn 6+ levels
- ‚úÖ **Complex Trees**: X√¢y d·ª±ng c√¢y giao d·ªãch ph·ª©c t·∫°p
- ‚úÖ **Performance**: T·ª± ƒë·ªông d·ª´ng th√¥ng minh khi v∆∞·ª£t gi·ªõi h·∫°n

### **CoinJoin Detection**
- ‚úÖ **Heuristic**: Wasabi, Samourai, Custom patterns
- ‚úÖ **ML Model**: T√≠ch h·ª£p model ƒë√£ train
- ‚úÖ **Accuracy**: K·∫øt h·ª£p nhi·ªÅu ph∆∞∆°ng ph√°p

### **Storage & Analysis**
- ‚úÖ **Neo4j**: L∆∞u tr·ªØ ƒë·ªì th·ªã ho√†n ch·ªânh
- ‚úÖ **Cache**: T·ªëi ∆∞u performance v·ªõi LRU cache
- ‚úÖ **Real-time**: Monitoring mempool li√™n t·ª•c

## üîê **Security**

- Rate limiting cho API calls
- Input validation v·ªõi Pydantic
- Error handling kh√¥ng expose sensitive data
- Neo4j authentication

## üìû **Support**

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ:
1. Ki·ªÉm tra logs t·∫°i `logs/api.log`
2. Verify Neo4j connection
3. Test v·ªõi `max_depth` nh·ªè h∆°n
4. Monitor system resources

---

**üéâ API ƒë√£ s·∫µn s√†ng ƒë·ªÉ ph√°t hi·ªán v√† ƒëi·ªÅu tra s√¢u c√°c giao d·ªãch CoinJoin!**